//execute arbitrary js code in a relatively safe environment
bot.eval = (function () {
window.URL = window.URL || window.webkitURL || window.mozURL || null;

// http://tinkerbin.com/84dPpGFr
var worker_code = atob( 'dmFyIGdsb2JhbCA9IHRoaXM7CgovKm1vc3QgZXh0cmEgZnVuY3Rpb25zIGNvdWxkIGJlIHBvc3NpYmx5IHVuc2FmZSovCnZhciB3aGl0ZXkgPSB7Cgknc2VsZicgICAgICAgICAgICAgICA6IDEsCgknb25tZXNzYWdlJyAgICAgICAgICA6IDEsCgkncG9zdE1lc3NhZ2UnICAgICAgICA6IDEsCgknZ2xvYmFsJyAgICAgICAgICAgICA6IDEsCgknd2hpdGV5JyAgICAgICAgICAgICA6IDEsIC8qbG9vayBtb20sIEknbSBhIHdoaXRlbGlzdCwgY29udGFpbmluZyBpdHNlbGYhKi8KCSdldmFsJyAgICAgICAgICAgICAgIDogMSwKCSdBcnJheScgICAgICAgICAgICAgIDogMSwKCSdCb29sZWFuJyAgICAgICAgICAgIDogMSwKCSdEYXRlJyAgICAgICAgICAgICAgIDogMSwKCSdGdW5jdGlvbicgICAgICAgICAgIDogMSwKCSdOdW1iZXInICAgICAgICAgICAgIDogMSwKCSdPYmplY3QnICAgICAgICAgICAgIDogMSwKCSdSZWdFeHAnICAgICAgICAgICAgIDogMSwKCSdTdHJpbmcnICAgICAgICAgICAgIDogMSwKCSdFcnJvcicgICAgICAgICAgICAgIDogMSwKCSdFdmFsRXJyb3InICAgICAgICAgIDogMSwKCSdSYW5nZUVycm9yJyAgICAgICAgIDogMSwKCSdSZWZlcmVuY2VFcnJvcicgICAgIDogMSwKCSdTeW50YXhFcnJvcicgICAgICAgIDogMSwKCSdUeXBlRXJyb3InICAgICAgICAgIDogMSwKCSdVUklFcnJvcicgICAgICAgICAgIDogMSwKCSdkZWNvZGVVUkknICAgICAgICAgIDogMSwKCSdkZWNvZGVVUklDb21wb25lbnQnIDogMSwKCSdlbmNvZGVVUkknICAgICAgICAgIDogMSwKCSdlbmNvZGVVUklDb21wb25lbnQnIDogMSwKCSdpc0Zpbml0ZScgICAgICAgICAgIDogMSwKCSdpc05hTicgICAgICAgICAgICAgIDogMSwKCSdwYXJzZUZsb2F0JyAgICAgICAgIDogMSwKCSdwYXJzZUludCcgICAgICAgICAgIDogMSwKCSdJbmZpbml0eScgICAgICAgICAgIDogMSwKCSdKU09OJyAgICAgICAgICAgICAgIDogMSwKCSdNYXRoJyAgICAgICAgICAgICAgIDogMSwKCSdOYU4nICAgICAgICAgICAgICAgIDogMSwKCSd1bmRlZmluZWQnICAgICAgICAgIDogMQp9OwoKWyBnbG9iYWwsIGdsb2JhbC5fX3Byb3RvX18gXS5mb3JFYWNoKGZ1bmN0aW9uICggb2JqICkgewoJT2JqZWN0LmdldE93blByb3BlcnR5TmFtZXMoIG9iaiApLmZvckVhY2goZnVuY3Rpb24oIHByb3AgKSB7CgoJCWlmKCAhd2hpdGV5Lmhhc093blByb3BlcnR5KCBwcm9wICkgKSB7CgkJCU9iamVjdC5kZWZpbmVQcm9wZXJ0eSggb2JqLCBwcm9wLCB7CgkJCQlnZXQgOiBmdW5jdGlvbigpIHsKCQkJCQl0aHJvdyAnU2VjdXJpdHkgRXhjZXB0aW9uOiBDYW5ub3QgYWNjZXNzICcgKyBwcm9wOwoJCQkJCXJldHVybiAxOwoJCQkJfSwKCgkJCQljb25maWd1cmFibGUgOiBmYWxzZQoJCQl9KTsKCQl9Cgl9KTsgLyplbmQgd2hpbGUqLwp9KTsKCgpPYmplY3QuZGVmaW5lUHJvcGVydHkoIEFycmF5LnByb3RvdHlwZSwgJ2pvaW4nLCB7Cgl3cml0YWJsZTogZmFsc2UsCgljb25maWd1cmFibGU6IGZhbHNlLAoJZW51bXJhYmxlOiBmYWxzZSwKCgl2YWx1ZTogKGZ1bmN0aW9uICggb2xkICkgewoJCXJldHVybiBmdW5jdGlvbiAoIGFyZyApIHsKCQkJaWYgKCB0aGlzLmxlbmd0aCA+IDUwMCB8fCAoYXJnICYmIGFyZy5sZW5ndGggPiA1MDApICkgewoJCQkJdGhyb3cgJ0V4Y2VwdGlvbjogdG9vIG1hbnkgaXRlbXMnOwoJCQl9CgoJCQlyZXR1cm4gb2xkLmFwcGx5KCB0aGlzLCBhcmd1bWVudHMgKTsKCQl9OwoJfSggQXJyYXkucHJvdG90eXBlLmpvaW4gKSkKCn0pOwoKCihmdW5jdGlvbigpewoJInVzZSBzdHJpY3QiOwoKCXZhciBjb25zb2xlID0gewoJCV9pdGVtcyA6IFtdLAoJCWxvZyA6IGZ1bmN0aW9uKCkgewoJCQljb25zb2xlLl9pdGVtcy5wdXNoLmFwcGx5KCBjb25zb2xlLl9pdGVtcywgYXJndW1lbnRzICk7CgkJfQoJfTsKCXZhciBwID0gY29uc29sZS5sb2cuYmluZCggY29uc29sZSApOwoKCWZ1bmN0aW9uIGV4ZWMgKCBjb2RlICkgewoJCXZhciByZXN1bHQ7CgkJdHJ5IHsKCQkJcmVzdWx0ID0gZXZhbCggJyJ1c2Ugc3RyaWN0IjtcbicgKyBjb2RlICk7CgkJfQoJCWNhdGNoICggZSApIHsKCQkJcmVzdWx0ID0gZS50b1N0cmluZygpOwoJCX0KCgkJcmV0dXJuIHJlc3VsdDsKCX0KCglzZWxmLm9ubWVzc2FnZSA9IGZ1bmN0aW9uICggZXZlbnQgKSB7CgkJdmFyIGpzb25TdHJpbmdpZnkgPSBKU09OLnN0cmluZ2lmeSwgLypiYWNrdXAqLwoJCQlyZXN1bHQgPSBleGVjKCBldmVudC5kYXRhLmNvZGUgKTsKCgkJLypKU09OLnN0cmluZ2lmeSBkb2VzIG5vdCBsaWtlIGZ1bmN0aW9ucywgZXJyb3JzIG9yIHVuZGVmaW5lZCovCgkJdmFyIHN0cmluZ2lmeSA9IGZ1bmN0aW9uICggaW5wdXQgKSB7CgkJCXZhciB0eXBlID0gKCB7fSApLnRvU3RyaW5nLmNhbGwoIGlucHV0ICkuc2xpY2UoIDgsIC0xICksCgkJCQlvdXRwdXQ7CgoJCQlpZiAoIEFycmF5LmlzQXJyYXkoaW5wdXQpICkgewoJCQkJb3V0cHV0ID0gaW5wdXQubWFwKGZ1bmN0aW9uICggaXRlbSApIHsKCQkJCQlyZXR1cm4gc3RyaW5naWZ5KCBpdGVtICk7CgkJCQl9KTsKCQkJfQoJCQllbHNlIGlmICggdHlwZSA9PT0gJ09iamVjdCcgKSB7CgkJCQlvdXRwdXQgPSBPYmplY3Qua2V5cyggaW5wdXQgKS5yZWR1Y2UoZnVuY3Rpb24gKCBrZXkgKSB7CgkJCQkJb3V0cHV0WyBrZXkgXSA9IHN0cmluZ2lmeSggaW5wdXRba2V5XSApOwoJCQkJfSwge30gKTsKCQkJfQoJCQllbHNlIGlmICggaW5wdXQgPT09IHVuZGVmaW5lZCApIHsKCQkJCW91dHB1dCA9ICd1bmRlZmluZWQnOwoJCQl9CgkJCWVsc2UgaWYgKCBpbnB1dCA9PT0gbnVsbCApIHsKCQkJCW91dHB1dCA9IG51bGw7CgkJCX0KCQkJZWxzZSB7CgkJCQlvdXRwdXQgPSBpbnB1dC50b1N0cmluZygpOwoJCQl9CgoJCQlyZXR1cm4gb3V0cHV0OwoJCX07CgoJCXBvc3RNZXNzYWdlKHsKCQkJYW5zd2VyIDoganNvblN0cmluZ2lmeSggc3RyaW5naWZ5KHJlc3VsdCkgKSwKCQkJbG9nICAgIDoganNvblN0cmluZ2lmeSggc3RyaW5naWZ5KGNvbnNvbGUuX2l0ZW1zKSApLAoJCX0pOwoJfTsKCn0pKCk7Cg==' );
var blob = new Blob( [worker_code], { type : 'application/javascript' } ),
	code_url = window.URL.createObjectURL( blob );

return function ( msg ) {
	var timeout,
		worker = new Worker( code_url );

	worker.onmessage = function ( evt ) {
		finish( dressUpAnswer(evt.data) );
	};

	worker.onerror = function ( error ) {
		finish( error.toString() );
	};

	worker.postMessage({
		code : msg.content.replace( /^>/, '' )
	});

	timeout = window.setTimeout(function() {
		finish( 'Maximum execution time exceeded' );
	}, 50 );

	function finish ( result ) {
		clearTimeout( timeout );
		worker.terminate();
		msg.directreply( result );
	}

	function dressUpAnswer ( answerObj ) {
		console.log( answerObj, 'eval answerObj' );
		var answer = answerObj.answer,
			log = JSON.parse( answerObj.log ),
			result;

		result = snipAndCodify( answer );

		if ( log && log.length ) {
			result += ' Logged: ' + snipAndCodify( log.join() ) + '';
		}

		return result;
	}
	function snipAndCodify ( str ) {
		var ret;

		if ( str.length > 400 ) {
			ret = '`' +  str.slice(0, 400) + '` (snip)';
		}
		else {
			ret = '`' + str +'`';
		}

		return ret;
	}
};
}());
